import pefile
import pandas
import csv
from pandas import read_csv
import os


from pandas import Series


def read_file(path):
    list_exe_name = os.listdir(path)
    return list_exe_name



def ParseExe(features, exe_path):
    #exe_path = "C:\\Users\\nasib\\Downloads\\installers\\ChromeSetup.exe"
    pe = pefile.PE(exe_path)
    features['hash'] = 0
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        for func in entry.imports:
            dll_name = entry.dll.decode('utf-8')
            try:
                if func.name.decode('utf-8') in features.keys():
                    features[func.name.decode('utf-8')] = 1
                    #print('Func name:', func.name.decode('utf-8'))
            except:
                print('Dll name:', dll_name)
    return features

def CleanSeries(series):
    keys = series.keys()
    for key in keys:
        series[key] = 0
    return series


def PrepFeatures():
    csv_path = "C:\\features.csv"
    header = read_csv(csv_path)
    return header.keys()

def WriteCvs(series, list_exe_name, path):

    with open("C:\\Users\\nasib\\Desktop\\result\\DataBase.csv", mode="w") as w_file:
        file_writer = csv.writer(w_file, delimiter=",", lineterminator="\r")
        first = True
        for file_name in list_exe_name:
            series['malware'] = 1
            full_name = path+file_name
            print(full_name)
            series = ParseExe(series, full_name)
            if first:
                first = False
                file_writer.writerow(series.keys())
            file_writer.writerow(series.values)
            series = CleanSeries(series)
    w_file.close()

path = "C:\\Users\\nasib\\Desktop\\Malwares1\\Malwares1"
list_exe_name = read_file(path)
path += "\\"
header = PrepFeatures()
data = []

for i in range(len(header)):
    data.append(0)
print(len(data))
print(len(header))
series = pandas.Series(data= data, index=header)
WriteCvs(series, list_exe_name, path)